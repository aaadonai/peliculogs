<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Epilogue</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<link href="bootstrap.min.css" rel="stylesheet" />

	<style>

		body {
			/* overflow-x: hidden; */
		}

		.form-control:focus { 
			border-color: darkgray !important;
			box-shadow: none !important;
		}

		nav {
			border-bottom: 1px solid lightgray;
		}

		.btn:focus {
			box-shadow: none !important;
		}

		#alert_error {
			margin-top: 75px;
			display: none;
		}

		#nav_profile {
		}
	
		#nav_back {
		}
		
		.nav_visible {
			display: inherit;
		}

		.nav_hidden {
			display: none;
		}
		
		#profile_icon {
			width: 30px;
			height: 30px;
			border-radius: 15px;
			background-color: lightgray;
		}
		
		.search_bar {
			margin-top: 75px;
		}
		
		#books_table {
		}
		
		.book_row {
			padding-top: 10px;
			clear: left;
		}
		
		.book_cover {
			width: 80px;
			height: 100px;
			padding-left: 5px;
			padding-right: 10px;
			border: 0px;
		}
		
		.book_title {
			padding-top: 15px;
			font-weight: bold;
		}
		
		.book_author {
			color: darkgray;
		}
		
		.books_normal {
			transform: translateX(0px);
			transition: transform 0.3s;
		}
		
		.books_offscreen {
			transform: translateX(-100%);
			transition: transform 0.3s;
		}
		
		#details_screen {
			position: absolute;
			top: 75px;
			display: none;
		}

		.details_offscreen {
			transform: translateX(100%);
			transition: transform 0.3s;
		}
		
		.details_shown {
			transform: translateX(0px);
			transition: transform 0.3s;
		}
		
	</style>
	
	<script>
	
		function verifyToken(handler) {
			let form = new FormData();
			form.append("token", document.epilogueToken);
			
			var options = {
				method: "POST",
				body: form
			};
			fetch("https://micro.blog/account/verify", options).then(response => response.json()).then(data => {
				if (data.error == undefined) {
					document.epilogueToken = data.token;
					document.epilogueUsername = data.username;
					document.epilogueAvatar = data.avatar;
					
					document.getElementById("profile_icon").setAttribute("src", document.epilogueAvatar);
				}
				else {
					document.getElementById("alert_error").style.display = "block";
					document.getElementById("alert_error").innerText = data.error;
				}
				
				handler();
			});
		}

		function loadBookshelves(handler) {
			var options = {
				headers: {
					"Authorization": "Bearer " + document.epilogueToken
				}
			};
			fetch("https://micro.blog/books/bookshelves", options).then(response => response.json()).then(data => {
				document.epilogueBookshelves = data;
				handler();
			});
		}

		function loadBooks(bookshelf_id) {
			var options = {
				headers: {
					"Authorization": "Bearer " + document.epilogueToken
				}
			};
			fetch("https://micro.blog/books/bookshelves/" + bookshelf_id, options).then(response => response.json()).then(data => {
				document.getElementById("books_table").innerHTML = "";
				addSearchBar();
				
				for (let i = 0; i < data.items.length; i++) {
					var book_item = data.items[i];
	
					var row_item = document.createElement("div");
					if (i == 0) {
						row_item.setAttribute("class", "book_first");
					}
					else {
						row_item.setAttribute("class", "book_row");
					}
					row_item.setAttribute("onClick", "showBookDetails();");
					
					var img_item = document.createElement("img");
					img_item.setAttribute("src", "https://micro.blog/photos/300x/" + book_item.image);
					img_item.setAttribute("class", "book_cover");
					img_item.setAttribute("align", "left");
					row_item.appendChild(img_item);
	
					var title_item = document.createElement("div");
					title_item.setAttribute("class", "book_title");
					title_item.innerText = book_item.title;
					row_item.appendChild(title_item);
	
					var author_item = document.createElement("div");
					author_item.setAttribute("class", "book_author");
					author_item.innerText = book_item.authors[0].name;
					row_item.appendChild(author_item);
					
					document.getElementById("books_table").appendChild(row_item);
				}
			});
		}

		function addSearchBar() {
			var bar_item = document.createElement("div");
			bar_item.setAttribute("class", "mb-3 search_bar");

			var input_item = document.createElement("input");
			input_item.setAttribute("type", "search");
			input_item.setAttribute("class", "form-control rounded-pill");
			input_item.setAttribute("id", "search_field");
			input_item.setAttribute("placeholder", "Search for books to add");
			bar_item.appendChild(input_item);
			
			document.getElementById("books_table").appendChild(bar_item);
		}

		function showBookDetails() {
			document.getElementById("details_screen").style.display = "inherit";
			
			setTimeout(function() {
				document.getElementById("books_table").classList.add("books_offscreen");
	
				document.getElementById("details_screen").classList.add("details_shown");
				document.getElementById("details_screen").classList.remove("details_offscreen");
	
				document.getElementById("nav_profile").classList.add("nav_hidden");
				document.getElementById("nav_profile").classList.remove("nav_visible");
	
				document.getElementById("nav_back").classList.add("nav_visible");
				document.getElementById("nav_back").classList.remove("nav_hidden");
			}, 50);
		}
	
		function closeBookDetails() {
			document.getElementById("books_table").classList.add("books_normal");
			document.getElementById("books_table").classList.remove("books_offscreen");

			document.getElementById("details_screen").classList.add("details_offscreen");
			document.getElementById("details_screen").classList.remove("details_shown");

			document.getElementById("nav_profile").classList.add("nav_visible");
			document.getElementById("nav_profile").classList.remove("nav_hidden");
			
			document.getElementById("nav_back").classList.add("nav_hidden");
			document.getElementById("nav_back").classList.remove("nav_visible");
			
			setTimeout(function() {
				document.getElementById("details_screen").style.display = "none";
			}, 300);
		}
	
		function checkToken() {
			verifyToken(function() {
				loadBookshelves(function() {
					loadBooks(document.epilogueBookshelves.items[0].id);
				});
			});
		}
	
	</script>
</head>
<body>

<nav class="navbar fixed-top navbar-light bg-light">

	<div class="container-fluid">
		
		<a href="#" id="nav_profile" onClick="">
			<img src="" id="profile_icon" />
		</a>
		
		<a href="#" id="nav_back" class="nav_hidden" onClick="closeBookDetails();">
			<svg fill="currentColor" xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 30 30" width="30px" height="30px"><path d="M 19.980469 3.9902344 A 1.0001 1.0001 0 0 0 19.292969 4.2929688 L 9.2929688 14.292969 A 1.0001 1.0001 0 0 0 9.2929688 15.707031 L 19.292969 25.707031 A 1.0001 1.0001 0 1 0 20.707031 24.292969 L 11.414062 15 L 20.707031 5.7070312 A 1.0001 1.0001 0 0 0 19.980469 3.9902344 z"/></svg>
		</a>			
		
		<a href="#" class="btn btn-light" id="nav_bookshelf" data-bs-toggle="offcanvas" data-bs-target="#offcanvasBottom" aria-controls="offcanvasBottom">
			<svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30" width="30px" height="30px"><path d="M 7 3 C 5.343 3 4 4.343 4 6 L 4 19 A 1.0001 1.0001 0 0 0 4.2949219 19.708984 C 4.6477556 20.972969 5.6303589 22 7 22 L 9 22 L 9 20 L 7 20 C 6.4349698 20 6 19.56503 6 19 C 6 18.542696 6.2910232 18.183861 6.6992188 18.058594 L 9 18.25 L 9 10 C 9 7.791 10.791 6 13 6 L 20 6 L 20 5 C 20 3.895 19.105 3 18 3 L 7 3 z M 14 8 C 12.343 8 11 9.343 11 11 L 11 24 A 1.0001 1.0001 0 0 0 11.294922 24.708984 C 11.647756 25.972969 12.630359 27 14 27 L 26 27 A 1.0001 1.0001 0 1 0 26 25 L 14 25 C 13.43497 25 13 24.56503 13 24 C 13 23.43497 13.43497 23 14 23 L 25 23 C 26.105 23 27 22.105 27 21 L 27 10 C 27 8.895 26.105 8 25 8 L 14 8 z M 16 12 L 22 12 C 22.552 12 23 12.448 23 13 C 23 13.552 22.552 14 22 14 L 16 14 C 15.448 14 15 13.552 15 13 C 15 12.448 15.448 12 16 12 z"/></svg>
			Want to read
		</a>

	</div>
	
</nav>
	
<div class="container" id="books_table">

	<div class="alert alert-warning" role="alert" id="alert_error">
	</div>
	
</div>

<div class="offcanvas offcanvas-bottom" tabindex="-1" id="offcanvasBottom" aria-labelledby="offcanvasBottomLabel">

	<div class="offcanvas-header">
		<h5 class="offcanvas-title" id="offcanvasBottomLabel">Bookshelves</h5>
	</div>
	<div class="offcanvas-body">
		<p>Want to read</p>
		<p>Currently reading</p>
		<p>Finished reading</p>
	</div>

</div>

<div class="container details_offscreen" id="details_screen">

	<p>Book details here.</p>

</div>

<script src="bootstrap.bundle.min.js"></script>

</body>
</html>
